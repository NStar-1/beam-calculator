<svelte:window on:resize={layout} />

<div
  bind:this={element}
  use:useActions={use}
  use:forwardEvents
  class={classMap({
    [className]: true,
    'mdc-banner': true,
    'mdc-banner--centered': centered,
    'mdc-banner--mobile-stacked': mobileStacked,
    ...internalClasses,
  })}
  style={Object.entries(internalStyles)
    .map(([name, value]) => `${name}: ${value};`)
    .concat([style])
    .join(' ')}
  role="banner"
  on:SMUIBannerButton:primaryActionClick={handlePrimaryActionClick}
  on:SMUIBannerButton:secondaryActionClick={handleSecondaryActionClick}
  {...exclude($$restProps, ['content$', 'textWrapper$', 'graphic$'])}
>
  <Fixed bind:fixed {width}>
    <div
      bind:this={content}
      class={classMap({
        [content$class]: true,
        'mdc-banner__content': true,
      })}
      role="alertdialog"
      aria-live="assertive"
      {...prefixFilter($$restProps, 'content$')}
    >
      {#if $$slots.icon || $$slots.label}
        <div
          class={classMap({
            [textWrapper$class]: true,
            'mdc-banner__graphic-text-wrapper': true,
          })}
          {...prefixFilter($$restProps, 'textWrapper$')}
        >
          {#if $$slots.icon}
            <div
              class={classMap({
                [graphic$class]: true,
                'mdc-banner__graphic': true,
              })}
              role="img"
              alt=""
              {...prefixFilter($$restProps, 'graphic$')}
            >
              <slot name="icon" />
            </div>
          {/if}
          <slot name="label" />
        </div>
      {/if}
      {#if $$slots.actions}
        <div class="mdc-banner__actions">
          <slot name="actions" />
        </div>
      {/if}
    </div>
  </Fixed>
</div>

<script>import { CloseReason, MDCBannerFoundation } from '@material/banner';
import { focusTrap as domFocusTrap } from '@material/dom';
import { onMount, onDestroy, getContext, setContext, tick } from 'svelte';
import { get_current_component } from 'svelte/internal';
import { forwardEventsBuilder, classMap, exclude, prefixFilter, useActions, dispatch, } from '@smui/common/internal';
import Fixed from './Fixed.svelte';
const { FocusTrap } = domFocusTrap;
const forwardEvents = forwardEventsBuilder(get_current_component());
// Remember to update $$Props if you add/remove/rename props.
export let use = [];
let className = '';
export { className as class };
export let style = '';
export let open = false;
export let autoClose = true;
export let centered = false;
export let fixed = false;
export let mobileStacked = false;
export let content$class = '';
export let textWrapper$class = '';
export let graphic$class = '';
let element;
let instance;
let internalClasses = {};
let internalStyles = {};
let content;
let focusTrap;
let addLayoutListener = getContext('SMUI:addLayoutListener');
let removeLayoutListener;
let width = undefined;
setContext('SMUI:label:context', 'banner');
setContext('SMUI:icon:context', 'banner');
setContext('SMUI:button:context', 'banner');
$: if (instance && instance.isOpen() !== open) {
    if (open) {
        instance.open();
    }
    else {
        instance.close(CloseReason.UNSPECIFIED);
    }
}
let previousMobileStacked = mobileStacked;
$: if (previousMobileStacked !== mobileStacked) {
    previousMobileStacked = mobileStacked;
    tick().then(layout);
}
if (addLayoutListener) {
    removeLayoutListener = addLayoutListener(layout);
}
onMount(() => {
    let initialFocusEl = getPrimaryActionEl();
    if (initialFocusEl) {
        focusTrap = new FocusTrap(element, { initialFocusEl });
    }
    instance = new MDCBannerFoundation({
        addClass,
        getContentHeight: () => {
            let offsetHeight = content.offsetHeight;
            if (offsetHeight === 0) {
                getElement().classList.add('smui-banner--force-show');
                offsetHeight = content.offsetHeight;
                getElement().classList.remove('smui-banner--force-show');
            }
            return offsetHeight;
        },
        notifyClosed: (reason) => {
            open = false;
            dispatch(getElement(), 'SMUIBanner:closed', { reason }, undefined, true);
        },
        notifyClosing: (reason) => {
            dispatch(getElement(), 'SMUIBanner:closing', { reason }, undefined, true);
        },
        notifyOpened: () => {
            open = true;
            dispatch(getElement(), 'SMUIBanner:opened', {}, undefined, true);
        },
        notifyOpening: () => {
            dispatch(getElement(), 'SMUIBanner:opening', {}, undefined, true);
        },
        notifyActionClicked: (action) => {
            dispatch(getElement(), 'SMUIBanner:actionClicked', { action });
        },
        releaseFocus: () => focusTrap && focusTrap.releaseFocus(),
        removeClass,
        setStyleProperty: addStyle,
        trapFocus: () => focusTrap && focusTrap.trapFocus(),
    });
    instance.init();
    layout();
    return () => {
        instance.destroy();
    };
});
onDestroy(() => {
    if (removeLayoutListener) {
        removeLayoutListener();
    }
});
function addClass(className) {
    if (!internalClasses[className]) {
        internalClasses[className] = true;
    }
}
function removeClass(className) {
    if (!(className in internalClasses) || internalClasses[className]) {
        internalClasses[className] = false;
    }
}
function addStyle(name, value) {
    if (internalStyles[name] != value) {
        if (value === '' || value == null) {
            delete internalStyles[name];
            internalStyles = internalStyles;
        }
        else {
            internalStyles[name] = value;
        }
    }
}
function getPrimaryActionEl() {
    var _a;
    return ((_a = element.querySelector('.mdc-banner__primary-action')) !== null && _a !== void 0 ? _a : undefined);
}
function handlePrimaryActionClick() {
    instance.handlePrimaryActionClick(!autoClose);
}
function handleSecondaryActionClick() {
    instance.handleSecondaryActionClick(!autoClose);
}
export function isOpen() {
    return open;
}
export function setOpen(value) {
    open = value;
}
export function layout() {
    if (fixed) {
        width = element.offsetWidth;
        if (width === 0) {
            element.classList.add('smui-banner--force-show');
            width = element.offsetWidth;
            element.classList.remove('smui-banner--force-show');
        }
    }
    if (instance) {
        instance.layout();
    }
}
export function getElement() {
    return element;
}
</script>
